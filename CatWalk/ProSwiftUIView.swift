//
//  ProView.swift
//  CatWalk
//
//  Created by  ÁéâÂüé on 2024/10/15.
//

import SwiftUI
import StoreKit

struct ProSwiftUIView: View {
    @StateObject var storeKit = StoreKitManager()
    @State var isPurchased: Bool = false
    @State var isPurchasedId: String? = ""
    
    func hexToColor(hex: String, alpha: Double = 1.0) -> Color {
        var formattedHex = hex.trimmingCharacters(in: CharacterSet.alphanumerics.inverted)
        if formattedHex.hasPrefix("#") {
            formattedHex.remove(at: formattedHex.startIndex)
        }
        
        let scanner = Scanner(string: formattedHex)
        var color: UInt64 = 0
        
        if scanner.scanHexInt64(&color) {
            let red = Double((color & 0xFF0000) >> 16) / 255.0
            let green = Double((color & 0x00FF00) >> 8) / 255.0
            let blue = Double(color & 0x0000FF) / 255.0
            return Color(red: red, green: green, blue: blue, opacity: alpha)
        } else {
            // ËøîÂõûÈªòËÆ§È¢úËâ≤ÔºåÂΩìËΩ¨Êç¢Â§±Ë¥•Êó∂
            return Color.black
        }
    }
    
    @Environment(\.presentationMode) var presentationMode: Binding<PresentationMode>
    
    @State private var selectedProductId: String = "CatsWalkPro"
    @State private var selectedProduct: Product? = nil
    
    
    
    let screenHeight = UIScreen.main.bounds.height
    var body: some View {
        
        
        VStack{
            HStack(alignment: .center,spacing:20){
                
                Button(action: {
                    self.presentationMode.wrappedValue.dismiss()
                }) {
                    Image(systemName: "chevron.backward")
                        .foregroundColor(.black)
                        .fontWeight(.bold)
                        .opacity(1)
                        .frame(width: 60, height: 60)
                        .background(DataColor.hexToColor(hex: "ffffff"))
                        .clipShape(Circle()) // Make the background circular
                    
                }.padding(.leading, 20)
                
                
                Spacer()
                Text("Pro").font(.system(size: 22)).fontWeight(/*@START_MENU_TOKEN@*/.bold/*@END_MENU_TOKEN@*/)
                
                Spacer()
                
                Color.clear.frame(width: 80)
                
                //                Button(action: {
                ////                    self.presentationMode.wrappedValue.dismiss()
                //                }) {
                ////                    Text("ÊÅ¢Â§çË¥≠‰π∞")
                //                    Image(systemName: "chevron.backward.2").font(.system(size: 24))
                //                        .frame(width: 80, height: 60)
                //                }.padding().opacity(0)
                //                
            }.frame(height: screenHeight <= 667 ? CGFloat(60) : CGFloat(60))
            
            
            ScrollView(){
                
         
            
            Image("cat12") // Âè≥‰∏ãËßíÁöÑÂõæÊ†á
                .resizable()
                .scaledToFit()
                .frame(height: 110) // ËÆæÁΩÆÂõæÊ†áÂ§ßÂ∞è
                .padding(5) //
            
            Text("Ëß£ÈîÅÊâÄÊúâÁöÑÂÆ†Áâ©").font(.system(size: 20))
                Spacer().frame(height: 5)
            Text("ÊØèÊúà‰ºöÊèê‰æõÊñ∞ÁöÑÂÆ†Áâ©‰ºô‰º¥").font(.system(size: 20))
//                    .foregroundStyle(DataColor.hexToColor(hex: "704918"))
            Spacer().frame(height: 30)
            //                    .cornerRadius(20, corners: [.topLeft, .topRight])
            //            VStack{
            ////                Spacer().frame(width: 50)
            //                
            //                Text("üêï  Ëß£ÈîÅÊâÄÊúâÁöÑÂä®Áâ©ÂÆ†Áâ©").font(.system(size: 22)) .background(DataColor.hexToColor(hex: "#ffffff"))
            //                    .cornerRadius(20, corners: [.topLeft, .topRight])
            //                
            //               
            //
            //            }.padding(50)
            //                .background(DataColor.hexToColor(hex: "#ffffff"))
            //                .cornerRadius(20)
            
            
            VStack {
                ForEach(storeKit.storeProducts, id: \.self) { product in
                    VStack {
                        Spacer().frame(height:16)
//                        if product.subscription != nil {
//                            HStack {
//                                Text(UserDefaults.standard.bool(forKey: "CatsWalkProSubscription") == true ? "üéâÊÇ®Â∑≤ÊØèÊúàÁª≠ËÆ¢" :"ÊØèÊúàÁª≠ËÆ¢")
//                                    .font(.system(size: 22, weight: .bold))
//                                //                                    .padding(.leading, 10) // Ê∑ªÂä†Â∑¶‰æßÂÜÖËæπË∑ùÔºåÁ°Æ‰øùÂÜÖÂÆπ‰∏çË¥¥Ëæπ
//                                //                                    .background(DataColor.hexToColor(hex: "#ffffff"))
//                                    .cornerRadius(20, corners: [.topLeft, .topRight])
//                                Spacer() // ‰øùËØÅÊñáÊú¨Â∑¶ÂØπÈΩê
//                            }
//                        } else {
                            HStack {
                                
                                Text(UserDefaults.standard.bool(forKey: "CatsWalkPro") == true ? "üéâÊÇ®Â∑≤ÊòØÊ∞∏‰πÖ‰ºöÂëò" :"Ê∞∏‰πÖ‰ºöÂëò")
                                    .font(.system(size: 22, weight: .bold))
                                //                                    .background(DataColor.hexToColor(hex: "#ffffff"))
                                    .cornerRadius(20, corners: [.topLeft, .topRight])
                                Spacer()
                            }
                            
//                        }
                        Spacer().frame(height:4)
                        
                        HStack {
                            Text(product.displayPrice)
                                .font(.system(size: 40, weight: .bold))
                                .foregroundColor(Color.black)
                            
                            Spacer()
                            
                            //
                            if selectedProductId == product.id {
                                Image(systemName: "checkmark.circle.fill")
                                    .foregroundColor(.black) // ÂõæÊ†áÁöÑÈ¢úËâ≤
                                    .font(.system(size: 32)) // ÂõæÊ†áÁöÑÂ§ßÂ∞è
                            } else{
                                Image(systemName: "checkmark.circle")
                                    .foregroundColor(DataColor.hexToColor(hex: "#818181")) // ÂõæÊ†áÁöÑÈ¢úËâ≤
                                    .font(.system(size: 32)) // ÂõæÊ†áÁöÑÂ§ßÂ∞è
                            }
                        }
                        Spacer().frame(height:4)
                        
//                        if product.subscription != nil {
//                            HStack {
//                                Text("‰ªÖ‰∏ÄÊùØÂíñÂï°ÁöÑ‰ª∑Ê†º")
//                                    .font(.system(size: 18)).opacity(0.7)
//                                
//                                Spacer()
//                            }
//                            
//                            
//                        } else {
                            HStack {
                                Text("‰∏ÄÊ¨°‰ªòË¥πÔºåÊ∞∏‰πÖÊã•Êúâ")
                                    .font(.system(size: 18)).opacity(0.7)
                                
                                Spacer()
                            }
                            
                            
//                        }
                    }
                    .padding(.horizontal, 30)
                    .padding(.bottom, 20)
                    .frame(maxWidth: .infinity, minHeight: 150)
                    
                    .background( selectedProductId == product.id ? DataColor.hexToColor(hex: "#fcc680") : DataColor.hexToColor(hex: "#ffffff")) // ÁÇπÂáªÂêéËÉåÊôØÂèòÈªÑ
                    //                    .background(DataColor.hexToColor(hex: "#ffffff"))
                    .cornerRadius(20)
                    .overlay( // Ê∑ªÂä†ÈªÑËâ≤ÊèèËæπÊïàÊûú
                        RoundedRectangle(cornerRadius: 20)
                            .stroke(selectedProductId == product.id ? DataColor.hexToColor(hex: "#603301") : Color.clear, lineWidth: 2)
                    )
                    .onTapGesture {
                        selectedProductId = product.id // ÁÇπÂáªÂêéÊõ¥Êñ∞ÈÄâ‰∏≠ÁöÑ‰∫ßÂìÅID
                        selectedProduct = product // ÁÇπÂáªÂêéÊõ¥Êñ∞ÈÄâ‰∏≠ÁöÑ‰∫ßÂìÅID
                    }
                    .opacity((UserDefaults.standard.bool(forKey: "CatsWalkPro") == true &&  product.id == "CatsWalkProSubscription") ? 0.4 : 1)
                    .padding(.vertical, 5)
                    .onAppear {
                        //                        checkPurchases(product: product)
                    }
                    
                }.onAppear {
                    if let oneTimeProduct = storeKit.storeProducts.first(where: { $0.subscription == nil }) {
                        selectedProductId = oneTimeProduct.id
                        selectedProduct = oneTimeProduct
                    }
                }
            }
            
            .padding(.horizontal, 20)
            
            
            
            
            Spacer().frame(height:70)
            
            
            
            //            ForEach(storeKit.storeProducts) {
            //                                    product in HStack{
            VStack{
                
                
                
                Button(action: {
                    //                        print(storeKit.storeProducts)
                    
                    //                        if isPurchased {
                    //                           
                    //        
                    //                           
                    //                        }
                    if UserDefaults.standard.bool(forKey: "CatsWalkPro") == true {
                        return
                    }
                    Task{
                        //                            try await storeKit.purchase(selectedProduct ?? <#default value#>)
                        if let productToPurchase = selectedProduct {
                            try await storeKit.purchase(productToPurchase)
                        } else {
                            // Â§ÑÁêÜ selectedProduct ‰∏∫Á©∫ÁöÑÊÉÖÂÜµÔºåÊØîÂ¶ÇÈÄâÊã©‰∏Ä‰∏™ÈªòËÆ§‰∫ßÂìÅÊàñÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                            print("No product selected for purchase.")
                        }
                    }
                    
                }) {
                    //                           CourseItem(storeKit: storeKit, product: product)
                    
                    if (isPurchased || UserDefaults.standard.bool(forKey: "CatsWalkPro") == true) {
//                        if(selectedProductId == "CatsWalkPro" ){
                            if( UserDefaults.standard.bool(forKey: "CatsWalkPro") == true){
                                Text("üéâÊÇ®Â∑≤ÊòØÊ∞∏‰πÖ‰ºöÂëò").font(.system(size: 20))
                            }else{
                                Text("‰∏ã‰∏ÄÊ≠•").font(.system(size: 20))
                            }
//                        }
                        
//                        if(selectedProductId == "CatsWalkProSubscription" ){
//                            if( UserDefaults.standard.bool(forKey: "CatsWalkProSubscription") == true){
//                                Text("üéâÊÇ®Â∑≤ÊàêÂäüËøûÁª≠ÊØèÊúàËÆ¢ÈòÖ").font(.system(size: 20))
//                            }
//                            else{
//                                Text("üéâÊÇ®Â∑≤ÊòØÊ∞∏‰πÖ‰ºöÂëò").font(.system(size: 20))
//                            }
//                        }
                        
                        //                               Text(Image(systemName: "checkmark"))
                        //                                   .bold()
                        //                                   .padding(10).foregroundColor(hexToColor(hex:"192d32"))
                        
                    } else {
                        Text("‰∏ã‰∏ÄÊ≠•").font(.system(size: 18))
                    }
                    
                }
                .frame(maxWidth: .infinity, minHeight: 50)
                
                .foregroundColor(hexToColor(hex:"192d32"))
                
                .background( DataColor.hexToColor(hex: "#fcc680") )
                
                //                       .cornerRadius(20)
                //                       .overlay( // Ê∑ªÂä†ÈªÑËâ≤ÊèèËæπÊïàÊûú
                //                               RoundedRectangle(cornerRadius: 20)
                //                                   .stroke( DataColor.hexToColor(hex: "#603301"), lineWidth: 2)
                //                           )
                .cornerRadius(15)
                .padding(.horizontal,20)
                .padding(.top,-10)
                .onChange(of: storeKit.purchasedCourses) { _ in
                    Task {
                        if let productToCheck = selectedProduct {
                            if let purchased = try? await storeKit.isPurchased(productToCheck) {
                                isPurchased = purchased
                                UserDefaults.standard.set(isPurchased, forKey: "isPurchased")
                                
                                if (isPurchased){
                                    UserDefaults.standard.set(true, forKey: "CatsWalkPro")
//                                    if(selectedProductId == "CatsWalkPro") {
//                                      
//                                    }
//                                    if(selectedProductId == "CatsWalkProSubscription") {
//                                        UserDefaults.standard.set(true, forKey: "CatsWalkProSubscription")
//                                    }
                                }
                                
                                
                            } else {
                                // Â¶ÇÊûúË¥≠‰π∞Ê£ÄÊü•Â§±Ë¥•ÔºåÈªòËÆ§Â∞Ü isPurchased ËÆæÁΩÆ‰∏∫ false
                                isPurchased = false
                                UserDefaults.standard.set(false, forKey: "isPurchased")
                                UserDefaults.standard.set(false, forKey: "CatsWalkPro")
                            }
                        } else {
                            // Â§ÑÁêÜ selectedProduct ‰∏∫Á©∫ÁöÑÊÉÖÂÜµ
                            print("No product selected to check purchase status.")
                        }
                    }
                }
         
            }
            
            
            //                                    }
            //            }
            
            
            
            
            Spacer().frame(height: 26)
            HStack{
                Spacer().frame(width: 10)
                Link(destination: URL(string: "https://docs.qq.com/doc/DUHVkTmNaUWVsc0V2")!) {
                    Text("‰ΩøÁî®Êù°Ê¨æ")
                        .font(.system(size: 12))
                        .opacity(0.6)
//                        .padding()
                }
//                Text("‰ΩøÁî®Êù°Ê¨æ").font(.system(size: 14)).opacity(0.6).padding()
                Spacer()
                Link(destination: URL(string: "https://docs.qq.com/doc/DUHJwUlRqWmF0dHdo")!) {
                    Text("ÈöêÁßÅÂçèËÆÆ").font(.system(size: 12)).opacity(0.6)
                }
              
                Spacer()

                Button(action: {
                    Task {
                        
                        try? await AppStore.sync()
                    }
                    
                }) {
                    Text("ÊÅ¢Â§çË¥≠‰π∞").font(.system(size: 12)).opacity(0.6)
                }
                
                Spacer().frame(width: 10)
                
                
            }
//           Text("ËÆ¢ÈòÖÂ∞Ü‰ºöËá™Âä®Áª≠Ë¥πÔºåÈô§ÈùûÊÇ®Âú®ÂΩìÂâçËÆ¢ÈòÖÁªìÊùüÂâç 24 Â∞èÊó∂ÂèñÊ∂àËá™Âä®ËÆ¢ÈòÖ„ÄÇÂ¶ÇÊûúÈúÄË¶ÅÂèñÊ∂àËÆ¢ÈòÖÔºåÂèØ‰ª•ÊâãÂä®Âú® Apple ID ËÆæÁΩÆÁÆ°ÁêÜ‰∏≠ÂÖ≥Èó≠Ëá™Âä®Áª≠Ë¥πÂäüËÉΩ„ÄÇ").font(.system(size: 14)).opacity(0.6)
            
            .padding(.horizontal,40)
            .padding(.top,0)
            }
          
            
            
            
            
            
            
            
            Spacer()
            
            
            
            
            
        }
        .frame(minWidth: 0, maxWidth: .infinity, minHeight: 0, maxHeight: .infinity, alignment: .center)
        
        .foregroundColor(hexToColor(hex:"000000"))
        .background(hexToColor(hex:"#f8f8f8"))
        .navigationBarHidden(true)
        .onAppear {
            
            
        }
        .onDisappear {
            
        }
        
        
        
        
        
        
        
    }
    
    
}

struct CourseItem: View {
    @ObservedObject var storeKit : StoreKitManager
    @State var isPurchased: Bool = false
    var product: Product
    
    var body: some View {
        VStack {
            if isPurchased {
                Text(Image(systemName: "checkmark"))
                    .bold()
                    .padding(10)
            } else {
                //                Text(product.displayPrice)
                //                    .padding(10)
            }
        }
        .onChange(of: storeKit.purchasedCourses) { _ in
            Task {
                isPurchased = (try? await storeKit.isPurchased(product)) ?? false
            }
        }
    }
}



#Preview {
    ProSwiftUIView()
}

